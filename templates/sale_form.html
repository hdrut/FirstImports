{% extends "base.html" %}
{% block content %}
<h2>{% if modo == "new" %}Nueva venta{% else %}Editar venta{% endif %}</h2>

<form class="card form" method="post" action="{% if modo == 'new' %}/ventas/nueva{% else %}/ventas/{{ venta.id }}/editar{% endif %}">
  <div class="grid2">
    <div>
      <label>Fecha</label>
      <input type="date" name="fecha" required value="{% if venta %}{{ venta.fecha.isoformat() }}{% else %}{{ today }}{% endif %}">
    </div>
    <div>
      <label>Medio de pago (opcional)</label>
      <select name="medio_pago">
        <option value="">—</option>
        {% for m in medios %}
          <option value="{{ m }}" {% if venta and venta.medio_pago == m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="grid2">
    <div>
      <label>Nombre</label>
      <input name="cliente_nombre" required value="{{ venta.cliente_nombre if venta else '' }}">
    </div>
    <div>
      <label>Apellido</label>
      <input name="cliente_apellido" required value="{{ venta.cliente_apellido if venta else '' }}">
    </div>
  </div>

  <div class="grid2">
    <div>
      <label>Teléfono (opcional)</label>
      <input name="telefono" value="{{ venta.telefono if venta and venta.telefono else '' }}">
    </div>
    <div>
      <label>Total</label>
      <div class="totalbox">$ <span id="total-view">0,00</span></div>
    </div>
  </div>

  <label>Observaciones (opcional)</label>
  <textarea name="observaciones" rows="2">{{ venta.observaciones if venta and venta.observaciones else '' }}</textarea>

  <hr/>

  <div class="row-between">
    <h3>Ítems</h3>
    <button type="button" class="btn secondary" onclick="addItemRow(); recalcTotal();">+ Agregar ítem</button>
  </div>

  <div class="tablewrap">
    <table class="table">
      <thead>
        <tr><th>Artículo</th><th>Descripción libre</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th></tr>
      </thead>
      <tbody id="items-body">
        {% for it in items %}
          <tr class="item-row">
            <td>
              <select name="item_articulo_id">
                <option value="">—</option>
                {% for a in articulos %}
                  <option value="{{ a.id }}" {% if it.articulo_id == a.id %}selected{% endif %}>{{ a.categoria }} • {{ a.nombre }}</option>
                {% endfor %}
              </select>
            </td>
            <td><input name="item_desc" value="{{ it.descripcion_libre or '' }}" placeholder="Opcional"></td>
            <td><input name="item_qty" value="{{ it.cantidad }}" inputmode="decimal"></td>
            <td><input name="item_unit" value="{{ it.precio_unitario }}" inputmode="decimal"></td>
            <td class="subtotal">0,00</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <template id="item-row-template">
    <tr class="item-row">
      <td>
        <select name="item_articulo_id">
          <option value="">—</option>
          {% for a in articulos %}
            <option value="{{ a.id }}">{{ a.categoria }} • {{ a.nombre }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input name="item_desc" placeholder="Opcional"></td>
      <td><input name="item_qty" value="1" inputmode="decimal"></td>
      <td><input name="item_unit" value="0" inputmode="decimal"></td>
      <td class="subtotal">0,00</td>
    </tr>
  </template>

  <div class="row-between">
    <a href="/ventas" class="btn secondary">Cancelar</a>
    <button class="btn" type="submit">Guardar</button>
  </div>
</form>

<script>
  (function(){
    const body = document.getElementById("items-body");
    if (body && body.children.length === 0) addItemRow();
    recalcTotal();
  })();
</script>

{% endblock %}
